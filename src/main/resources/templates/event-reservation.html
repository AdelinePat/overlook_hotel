<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${titlePage}">Overlook Hotel - Réservation événement</title>
  <link rel="stylesheet" th:href="@{/css/main.css}"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,600&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/7b20e7d8d0.js" crossorigin="anonymous"></script>
  <script th:if="${session.successMessage != null}">
    alert([[${session.successMessage}]]);
  </script>

</head>
<body>

<header>
    <div class="header" th:replace="fragments/navbar :: navbar"></div>
</header>

<div class="page">
    <div class="content">

        <!-- ✅ Messages globaux -->
        <div th:if="${errorMessage}" class="alert alert-danger"
             style="color: red; font-weight: bold; margin: 1em 0;">
            <p th:text="${errorMessage}"></p>
        </div>

        <div th:if="${successMessage}" class="alert alert-success"
             style="color: green; font-weight: bold; margin: 1em 0;">
            <p th:text="${successMessage}"></p>
        </div>

        <!-- FILTER SECTION -->





        <form class="filter-bar mt50" th:action="@{/event-reservation}" method="post" th:object="${filterFields}">

            <div class="filter-input reservation-input">
                <label><i class="fa-solid fa-champagne-glasses"></i></label>
                <select th:field="*{eventType}">
                    <option value="">-- Type d'événement --</option>
                    <option th:each="et : ${eventTypes}"
                            th:value="${et}"
                            th:text="${@displayText.capitalize(et)}"></option>
                </select>
            </div>

            <div class="filter-input reservation-input">
                <label><i class="fa-solid fa-tags"></i></label>
                <select th:field="*{placeTypeId}">
                    <option value="">-- Type d'espace --</option>
                    <option th:each="pt : ${placeTypeList}"
                            th:value="${pt.id}"
                            th:text="${@displayText.capitalize(pt.name)}">
                    </option>
                </select>
            </div>


            <div class="filter-input reservation-input">
                <label><i class="fa-solid fa-calendar-days"></i></label>

                <input type="datetime-local"
                       th:field="*{startDate}"
                       th:value="${filterFields.startDate != null ? #temporals.format(filterFields.startDate, 'yyyy-MM-dd''T''HH:mm') : #temporals.format(T(java.time.LocalDateTime).now(), 'yyyy-MM-dd''T''HH:mm')}" />

                <input type="datetime-local"
                       th:field="*{endDate}"
                       th:value="${filterFields.endDate != null ? #temporals.format(filterFields.endDate, 'yyyy-MM-dd''T''HH:mm') : #temporals.format(T(java.time.LocalDateTime).now().plusHours(1), 'yyyy-MM-dd''T''HH:mm')}" />
            </div>




            <button class="btn lh12" type="submit">Rechercher</button>
        </form>

        <!-- SEARCH RESULTS -->
        <h1>Résultats: <span th:text="${#lists.size(placeList)}"></span></h1>
        <div class="booking-content">
            <div class="book-card"
                 th:each="place : ${placeList}"
                 th:attr="data-hourly=${place.hourlyPrice}">
                <div class="booking-img"
                     th:classappend="${place.placeType != null ? place.placeType.name.toLowerCase() : 'default'}">
                    <p class="price" th:text="${place.hourlyPrice + ' €/heure'}"></p>
                </div>

                <div class="card-description">
                    <h3 th:text="${@displayText.capitalize(place.placeType != null ? place.placeType.name : 'Espace')}"></h3>

                    <form th:action="@{/event-reservation/{id}(id=${place.id})}" method="post" th:object="${filterFields}">
                        <input type="hidden" th:field="*{placeTypeId}"/>
                        <input type="hidden" th:field="*{startDate}"/>
                        <input type="hidden" th:field="*{endDate}"/>
                        <input type="hidden" th:field="*{eventType}"/>
                        <button type="submit" class="btn m10">Ajouter au panier</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- EVENT CART -->
        <div class="display-focus" th:if="${session.eventCart != null}">
            <h2>Votre panier d’événements</h2>
            <ul>
                <li th:each="place : ${session.eventCart}"
                    th:attr="data-hourly=${place.hourlyPrice}">
                    <p>
                        <strong th:text="${@displayText.capitalize(place.placeType.name)}"></strong>
                        — Prix : <span th:text="${place.hourlyPrice}"></span> €/h
                        — <span class="calc-total" data-role="total">—</span>


                    <form th:action="@{/event-reservation/remove/{id}(id=${place.id})}"
                          method="post"
                          class="remove-form"
                          style="display:inline-block;margin-left:.5rem">
                        <input type="hidden" th:name="startDate" th:value="${filterFields.startDate}" />
                        <input type="hidden" th:name="endDate" th:value="${filterFields.endDate}" />
                        <input type="hidden" th:name="eventType" th:value="${filterFields.eventType}" />
                        <button class="btn bg-purple" type="submit" title="Retirer">Retirer</button>
                    </form>
                    </p>
                    <hr/>
                </li>
            </ul>

            <h3>Total panier : <span id="event-cart-total">—</span></h3>


            <div th:if="${successMessage}" class="alert alert-success" style="color: green; font-weight: bold; margin: 1em 0;">
                <p th:text="${successMessage}"></p>
            </div>

            <form th:action="@{/event-reservation/confirm}" method="post">
                <input type="hidden" name="placeTypeId" th:value="${filterFields.placeTypeId}"/>
                <input type="hidden" name="startDate" th:value="${filterFields.startDate}"/>
                <input type="hidden" name="endDate" th:value="${filterFields.endDate}"/>
                <input type="hidden" name="eventType" th:value="${filterFields.eventType}"/>
                <button class="btn">Confirmer toutes les réservations</button>
            </form>

            <form th:action="@{/event-reservation/clear}" method="post" style="margin-top:.5rem">
                <button class="btn">Vider le panier</button>


            </form>
            <form th:action="@{/event-reservation/list}" method="get" style="margin-top:.5rem">
                <button class="btn bg-purple" type="submit">Voir mes réservations</button>
            </form>
        </div>
    </div>


</div>
<div th:replace="fragments/footer :: footer"></div>
</body>


<script>
  (function () {
    const startInput  = document.querySelector('input[name="startDate"]');
    const endInput    = document.querySelector('input[name="endDate"]');
    const cartTotalEl = document.getElementById('event-cart-total');

    function parseLocalDateTime(inputEl) {
      if (!inputEl || !inputEl.value) return null;
      const v = inputEl.value;
      const iso = v.includes('T') ? v : v.replace(' ', 'T');
      const d = new Date(iso);
      return isNaN(d.getTime()) ? null : d;
    }

    function hoursRoundedUp(ms) {
      if (ms <= 0) return 0;
      const H = 60 * 60 * 1000;
      return Math.ceil(ms / H);
    }

    function formatMoney(n) {
      return new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(n);
    }

    function updateTotals() {
      const start = parseLocalDateTime(startInput);
      const end   = parseLocalDateTime(endInput);

      let hours = 0;
      if (start && end) {
        hours = hoursRoundedUp(end - start);
      }

      let cartSum = 0;

      // sous-total par réservation
      document.querySelectorAll('.display-focus li[data-hourly]').forEach(li => {
        const rate  = Number(li.dataset.hourly || 0);
        const field = li.querySelector('[data-role="total"]');

        if (hours > 0 && rate > 0) {
          const lineTotal = hours * rate;
          cartSum += lineTotal;
          if (field) field.textContent = `${formatMoney(lineTotal)} € (${hours} h)`;
        } else {
          if (field) field.textContent = '—';
        }
      });

      // total global
      if (cartTotalEl) {
        cartTotalEl.textContent = (hours > 0 && cartSum > 0)
          ? `${formatMoney(cartSum)} €`
          : '—';
      }
    }

    // recalcul si on change les dates
    startInput && startInput.addEventListener('change', updateTotals);
    endInput   && endInput.addEventListener('change', updateTotals);

    //recalcul initial
    updateTotals();

    // suppression d’un item sans rechargement
    document.querySelectorAll('.remove-form').forEach(form => {
      form.addEventListener('submit', e => {
        e.preventDefault(); // empêche le rechargement
        const li = form.closest('li');
        const url = form.action;


       fetch(url, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => {
          if (res.ok) {
          li.remove();
        updateTotals();     // recalcule le total
        } else {
          alert ("Erreur lors du retrait de l'élément.");
        }
      })
      .catch(() => alert ("Impossible de contacter le serveur"));
    });
  })
  })();
</script>

</html>